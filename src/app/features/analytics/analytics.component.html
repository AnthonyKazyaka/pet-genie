
    <div class="analytics-container">
      <header class="page-header">
        <div class="header-content">
          <h1>Analytics</h1>
          <p class="subtitle">Insights into your pet sitting business</p>
        </div>
        <div class="header-actions">
          <mat-button-toggle-group [(ngModel)]="timeRange" (change)="onTimeRangeChange()">
            <mat-button-toggle value="week">This Week</mat-button-toggle>
            <mat-button-toggle value="month">This Month</mat-button-toggle>
            <mat-button-toggle value="3months">3 Months</mat-button-toggle>
          </mat-button-toggle-group>
          <button mat-stroked-button (click)="openExportDialog()" [disabled]="isLoading() || events().length === 0">
            <mat-icon>download</mat-icon>
            Export
          </button>
        </div>
      </header>

      @if (!isConnected()) {
        <app-empty-state
          icon="cloud_off"
          title="Connect Google Calendar"
          description="Connect your Google Calendar to view analytics about your pet sitting business."
          actionLabel="Go to Settings"
          actionLink="/settings"
          actionIcon="settings"
        ></app-empty-state>
      } @else if (isLoading()) {
        <!-- Loading Skeleton -->
        <section class="summary-cards">
          @for (i of [1,2,3,4]; track i) {
            <mat-card class="summary-card skeleton">
              <mat-card-content>
                <div class="summary-icon skeleton-icon"></div>
                <div class="summary-info">
                  <div class="skeleton-text large"></div>
                  <div class="skeleton-text small"></div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </section>
        <mat-card class="chart-card">
          <mat-card-header>
            <div class="skeleton-text medium"></div>
          </mat-card-header>
          <mat-card-content>
            <div class="skeleton-chart"></div>
          </mat-card-content>
        </mat-card>
      } @else if (hasWorkEvents() === false) {
        <app-empty-state
          icon="bar_chart"
          title="No data yet"
          description="Once you have pet sitting appointments in your calendar, you'll see analytics here."
          actionLabel="View Calendar"
          actionLink="/calendar"
          actionIcon="event"
        ></app-empty-state>
      } @else {
        <!-- Summary Cards -->
        <section class="summary-cards">
          <mat-card class="summary-card">
            <mat-card-content>
              <div class="summary-icon appointments">
                <mat-icon>event</mat-icon>
              </div>
              <div class="summary-info">
                <span class="summary-value">{{ summaryStats().totalEvents }}</span>
                <span class="summary-label">Total Appointments</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="summary-card">
            <mat-card-content>
              <div class="summary-icon hours">
                <mat-icon>schedule</mat-icon>
              </div>
              <div class="summary-info">
                <span class="summary-value">{{ summaryStats().totalHours }}</span>
                <span class="summary-label">Work Hours</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="summary-card">
            <mat-card-content>
              <div class="summary-icon clients">
                <mat-icon>pets</mat-icon>
              </div>
              <div class="summary-info">
                <span class="summary-value">{{ summaryStats().uniqueClients }}</span>
                <span class="summary-label">Unique Clients</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="summary-card">
            <mat-card-content>
              <div class="summary-icon average">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="summary-info">
                <span class="summary-value">{{ summaryStats().avgPerDay }}</span>
                <span class="summary-label">Avg Hours/Day</span>
              </div>
            </mat-card-content>
          </mat-card>
        </section>

        <!-- Workload Trend Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Workload Trend</mat-card-title>
            <mat-card-subtitle>Daily work hours over time</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="bar-chart" role="img" aria-label="Bar chart showing daily workload">
              @for (day of dailyStats(); track day.date.toISOString()) {
                <div
                  class="bar-container"
                  [matTooltip]="getBarTooltip(day)"
                  role="listitem"
                  [attr.aria-label]="getBarTooltip(day)"
                >
                  <div
                    class="bar"
                    [style.height.%]="getBarHeight(day.workMinutes)"
                    [class]="'workload-' + day.level"
                  ></div>
                  <span class="bar-label">{{ day.label }}</span>
                </div>
              }
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color workload-comfortable"></span>
                Comfortable
              </div>
              <div class="legend-item">
                <span class="legend-color workload-busy"></span>
                Busy
              </div>
              <div class="legend-item">
                <span class="legend-color workload-high"></span>
                High
              </div>
              <div class="legend-item">
                <span class="legend-color workload-burnout"></span>
                Burnout
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="charts-row">
          <!-- Service Breakdown -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Service Breakdown</mat-card-title>
              <mat-card-subtitle>Types of appointments</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="donut-chart-container">
                <div class="donut-chart" role="img" aria-label="Donut chart showing service breakdown">
                  <svg viewBox="0 0 100 100" class="donut-svg">
                    @for (segment of serviceBreakdown(); track segment.type; let i = $index) {
                      <circle
                        class="donut-segment-circle"
                        [attr.stroke]="segment.color"
                        [attr.stroke-dasharray]="getStrokeDasharray(segment.percentage)"
                        [attr.stroke-dashoffset]="getStrokeDashoffset(i)"
                        fill="transparent"
                        stroke-width="10"
                        cx="50"
                        cy="50"
                        r="40"
                      />
                    }
                  </svg>
                  <div class="donut-center">
                    <span class="donut-total">{{ summaryStats().totalEvents }}</span>
                    <span class="donut-label">visits</span>
                  </div>
                </div>
                <div class="service-legend">
                  @for (service of serviceBreakdown(); track service.type) {
                    <div class="service-item">
                      <span class="service-color" [style.background]="service.color"></span>
                      <span class="service-name">{{ service.type }}</span>
                      <span class="service-percentage">{{ service.percentage | number:'1.0-0' }}%</span>
                      <span class="service-count">{{ service.count }}</span>
                    </div>
                  }
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Busiest Days -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Busiest Days</mat-card-title>
              <mat-card-subtitle>Average hours by day of week</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="day-chart">
                @for (day of dayOfWeekStats(); track day.day) {
                  <div class="day-bar-container">
                    <span class="day-name">{{ day.day }}</span>
                    <div class="day-bar-wrapper">
                      <div
                        class="day-bar"
                        [style.width.%]="getDayBarWidth(day.averageMinutes)"
                        [class.highlight]="day.averageMinutes === maxDayMinutes()"
                      ></div>
                    </div>
                    <span class="day-hours">{{ formatMinutes(day.averageMinutes) }}</span>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Top Clients -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Top Clients</mat-card-title>
            <mat-card-subtitle>Most frequent appointments</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            @if (topClients().length === 0) {
              <div class="empty-clients">
                <mat-icon>person_off</mat-icon>
                <p>No client data available. Client names are extracted from event titles.</p>
              </div>
            } @else {
              <div class="clients-grid">
                @for (client of topClients(); track client.name; let i = $index) {
                  <div class="client-card" [class.top-3]="i < 3">
                    <div class="client-rank" [class]="'rank-' + (i + 1)">
                      @if (i < 3) {
                        <mat-icon>{{ i === 0 ? 'emoji_events' : 'star' }}</mat-icon>
                      } @else {
                        {{ i + 1 }}
                      }
                    </div>
                    <div class="client-info">
                      <span class="client-name">{{ client.name }}</span>
                      <span class="client-stats">
                        <span class="stat">
                          <mat-icon>event</mat-icon>
                          {{ client.visitCount }} visits
                        </span>
                        <span class="stat">
                          <mat-icon>schedule</mat-icon>
                          {{ formatMinutes(client.totalMinutes) }}
                        </span>
                      </span>
                    </div>
                    <div class="client-progress">
                      <div
                        class="progress-bar"
                        [style.width.%]="getClientBarWidth(client.visitCount)"
                      ></div>
                    </div>
                  </div>
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      }
    </div>
  
