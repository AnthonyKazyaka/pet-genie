<div class="template-dialog">
  <div class="dialog-header">
    <h2>{{ data.mode === 'create' ? 'Create Template' : 'Edit Template' }}</h2>
    <button mat-icon-button (click)="close()" aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="form" (ngSubmit)="save()">
    <mat-dialog-content>
      <!-- Icon Selection -->
      <div class="icon-section">
        <label>Choose an icon</label>
        <div class="icon-grid">
          @for (emoji of availableIcons; track emoji) {
            <button
              type="button"
              class="icon-option"
              [class.selected]="form.get('icon')?.value === emoji"
              (click)="selectIcon(emoji)"
            >
              {{ emoji }}
            </button>
          }
        </div>
      </div>

      <!-- Basic Info -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Template Name</mat-label>
        <input matInput formControlName="name" placeholder="e.g., Morning Dog Walk" />
        <mat-error *ngIf="form.get('name')?.hasError('required')">Name is required</mat-error>
      </mat-form-field>

      <div class="row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Service Type</mat-label>
          <mat-select formControlName="type">
            @for (type of serviceTypes; track type.value) {
              <mat-option [value]="type.value">{{ type.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Duration</mat-label>
          <mat-select formControlName="duration">
            @for (duration of durations; track duration.value) {
              <mat-option [value]="duration.value">{{ duration.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Default start time</mat-label>
          <input matInput type="time" formControlName="defaultStartTime" />
          <mat-hint>Optional: HH:mm</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Default end time</mat-label>
          <input matInput type="time" formControlName="defaultEndTime" />
          <mat-hint>Optional: HH:mm</mat-hint>
        </mat-form-field>
      </div>

      <mat-divider></mat-divider>

      <!-- Travel Settings -->
      <div class="travel-section">
        <div class="toggle-row">
          <div class="toggle-info">
            <mat-icon>directions_car</mat-icon>
            <div>
              <span class="toggle-label">Include travel time</span>
              <span class="toggle-description">Add buffer time for travel to and from appointments</span>
            </div>
          </div>
          <mat-slide-toggle formControlName="includeTravel"></mat-slide-toggle>
        </div>

        @if (form.get('includeTravel')?.value) {
          <mat-form-field appearance="outline" class="travel-buffer-field">
            <mat-label>Travel buffer (minutes)</mat-label>
            <input matInput type="number" formControlName="travelBuffer" min="0" max="120" />
            <mat-hint>Time added before and after each appointment</mat-hint>
          </mat-form-field>
        }
      </div>

      <mat-divider></mat-divider>

      <!-- Notes -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Default Notes (optional)</mat-label>
        <textarea
          matInput
          formControlName="defaultNotes"
          placeholder="Add default notes for this template..."
          rows="2"
        ></textarea>
      </mat-form-field>

      <!-- Preview -->
      <div class="preview-section">
        <h4>Preview</h4>
        <div class="preview-card">
          <span class="preview-icon">{{ form.get('icon')?.value || 'ðŸ“…' }}</span>
          <div class="preview-content">
            <span class="preview-name">{{ form.get('name')?.value || 'Template Name' }}</span>
            <span class="preview-details">
              {{ getSelectedTypeLabel() }} Â· {{ getSelectedDurationLabel() }}
              @if (form.get('includeTravel')?.value) {
                <span> Â· +{{ form.get('travelBuffer')?.value }}min travel</span>
              }
              @if (getTimeRangeLabel()) {
                <span> Â· {{ getTimeRangeLabel() }}</span>
              }
            </span>
          </div>
        </div>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button type="button" (click)="close()">Cancel</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="!form.valid">
        {{ data.mode === 'create' ? 'Create Template' : 'Save Changes' }}
      </button>
    </mat-dialog-actions>
  </form>
</div>
