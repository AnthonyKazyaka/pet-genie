
    <div class="calendar-container" (keydown)="handleKeydown($event)">
      <header class="calendar-header">
        <div class="header-left">
          <button mat-icon-button (click)="navigatePrevious()" aria-label="Previous">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <button mat-icon-button (click)="navigateNext()" aria-label="Next">
            <mat-icon>chevron_right</mat-icon>
          </button>
          <h1>{{ currentTitle() }}</h1>
          <button mat-stroked-button (click)="goToToday()">Today</button>
        </div>
        <div class="header-right">
          <mat-button-toggle-group [(ngModel)]="viewMode" (change)="onViewModeChange()" aria-label="Calendar view">
            <mat-button-toggle value="month">Month</mat-button-toggle>
            <mat-button-toggle value="week">Week</mat-button-toggle>
            <mat-button-toggle value="day">Day</mat-button-toggle>
          </mat-button-toggle-group>
          <button mat-icon-button (click)="refreshEvents()" [disabled]="isLoading()" aria-label="Refresh">
            <mat-icon [class.spinning]="isLoading()">refresh</mat-icon>
          </button>
        </div>
      </header>

      @if (isLoading()) {
        <div class="loading-overlay">
          <app-skeleton-loader type="calendar"></app-skeleton-loader>
        </div>
      }

      @if (!isConnected()) {
        <app-empty-state
          icon="cloud_off"
          title="Connect Google Calendar"
          description="Connect your Google Calendar to view your pet sitting appointments."
          actionLabel="Go to Settings"
          actionLink="/settings"
          actionIcon="settings"
        ></app-empty-state>
      } @else {
        <div class="calendar-layout">
          <!-- Mini Calendar (sidebar) -->
          <aside class="mini-calendar-sidebar" *ngIf="viewMode !== 'month' && !isMobile()">
            <div class="mini-calendar">
              <div class="mini-header">
                <button mat-icon-button (click)="navigateMiniPrevious()" aria-label="Previous month">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <span>{{ format(miniCalendarDate(), 'MMM yyyy') }}</span>
                <button mat-icon-button (click)="navigateMiniNext()" aria-label="Next month">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>
              <div class="mini-weekdays">
                @for (day of weekDaysShort; track day) {
                  <span>{{ day }}</span>
                }
              </div>
              <div class="mini-days">
                @for (day of miniCalendarDays(); track day.date.toISOString()) {
                  <button
                    class="mini-day"
                    [class.other-month]="!day.isCurrentMonth"
                    [class.today]="day.isToday"
                    [class.selected]="day.isSelected"
                    [class.has-events]="day.events.length > 0"
                    (click)="selectMiniDay(day)"
                  >
                    {{ format(day.date, 'd') }}
                  </button>
                }
              </div>
            </div>

            <!-- Workload Summary -->
            <div class="workload-summary">
              <h3>Workload Summary</h3>
              <div class="workload-legend">
                <div class="legend-item">
                  <span class="legend-color comfortable"></span>
                  <span>Comfortable</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color busy"></span>
                  <span>Busy</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color high"></span>
                  <span>High</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color burnout"></span>
                  <span>Burnout</span>
                </div>
              </div>
            </div>
          </aside>

          <!-- Main Calendar View -->
          <div class="calendar-main">
            @switch (viewMode) {
              @case ('month') {
                <div class="month-view" role="grid" aria-label="Calendar month view">
                  <div class="weekday-headers" role="row">
                    @if (showWeekNumbers()) {
                      <div class="week-number-header" role="columnheader">Wk</div>
                    }
                    @for (day of weekDays; track day) {
                      <div class="weekday-header" role="columnheader">{{ day }}</div>
                    }
                  </div>
                  <div class="days-grid">
                    @for (day of calendarDays(); track day.date.toISOString(); let i = $index) {
                      @if (showWeekNumbers() && i % 7 === 0) {
                        <div class="week-number">{{ getWeekNumber(day.date) }}</div>
                      }
                      <div
                        class="calendar-day"
                        [class.other-month]="!day.isCurrentMonth"
                        [class.today]="day.isToday"
                        [class.selected]="day.isSelected"
                        [class.has-events]="day.events.length > 0"
                        [class.workload-comfortable]="day.workloadLevel === 'comfortable' && day.workloadMinutes > 0"
                        [class.workload-busy]="day.workloadLevel === 'busy'"
                        [class.workload-high]="day.workloadLevel === 'high'"
                        [class.workload-burnout]="day.workloadLevel === 'burnout'"
                        (click)="selectDay(day)"
                        (keydown.enter)="selectDay(day)"
                        (keydown.space)="selectDay(day); $event.preventDefault()"
                        tabindex="0"
                        role="gridcell"
                        [attr.aria-label]="getDayAriaLabel(day)"
                        [attr.aria-selected]="day.isSelected"
                      >
                        <div class="day-header">
                          <span class="day-number">{{ format(day.date, 'd') }}</span>
                          @if (day.workloadMinutes > 0) {
                            <span class="workload-indicator" [matTooltip]="getWorkloadTooltip(day)">
                              {{ formatWorkloadHours(day.workloadMinutes) }}
                            </span>
                          }
                        </div>
                        <div class="day-events">
                          @for (event of day.events.slice(0, 3); track event.id) {
                            <div
                              class="event-chip"
                              [class.work-event]="event.isWorkEvent"
                              [class.overnight]="event.isOvernightEvent"
                              [matTooltip]="getEventTooltip(event)"
                              (click)="showEventDetails(event)"
                            >
                              <span class="event-time">{{ format(event.start, 'h:mma').toLowerCase() }}</span>
                              {{ event.title }}
                            </div>
                          }
                          @if (day.events.length > 3) {
                            <div class="more-events" (click)="selectDay(day); $event.stopPropagation()">
                              +{{ day.events.length - 3 }} more
                            </div>
                          }
                        </div>
                        <!-- Workload bar indicator -->
                        @if (day.workloadMinutes > 0) {
                          <div 
                            class="workload-bar" 
                            [class]="'workload-' + day.workloadLevel"
                            [style.width.%]="getWorkloadBarWidth(day.workloadMinutes)"
                          ></div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }

              @case ('week') {
                <div class="week-view" role="grid" aria-label="Calendar week view">
                  <div class="week-header" role="row">
                    @if (showWeekNumbers()) {
                      <div class="week-number-header">Wk {{ getWeekNumber(currentDate()) }}</div>
                    }
                    @for (day of weekViewDays(); track day.date.toISOString()) {
                      <div 
                        class="week-day-header" 
                        [class.today]="day.isToday"
                        [class.selected]="day.isSelected"
                        role="columnheader"
                      >
                        <span class="day-name">{{ format(day.date, 'EEE') }}</span>
                        <span class="day-number" [class.today-number]="day.isToday">{{ format(day.date, 'd') }}</span>
                        @if (day.workloadMinutes > 0) {
                          <span class="workload-badge" [class]="'workload-' + day.workloadLevel">
                            {{ formatWorkloadHours(day.workloadMinutes) }}
                          </span>
                        }
                      </div>
                    }
                  </div>
                  
                  <!-- Time grid -->
                  <div class="week-time-grid">
                    <div class="time-column">
                      @for (hour of hoursOfDay; track hour) {
                        <div class="time-slot">
                          <span class="time-label">{{ formatHour(hour) }}</span>
                        </div>
                      }
                    </div>
                    <div class="week-body">
                      @for (day of weekViewDays(); track day.date.toISOString()) {
                        <div 
                          class="week-day-column"
                          [class.today]="day.isToday"
                          (click)="selectDayFromWeek(day)"
                        >
                          <!-- Time slots background -->
                          @for (hour of hoursOfDay; track hour) {
                            <div class="hour-slot"></div>
                          }
                          <!-- Events positioned by time -->
                          @for (event of day.events; track event.id) {
                            <div
                              class="week-event"
                              [class.work-event]="event.isWorkEvent"
                              [class.overnight-event]="event.isOvernightEvent"
                              [style.top.px]="getEventTop(event)"
                              [style.height.px]="getEventHeight(event)"
                              [matTooltip]="getEventTooltip(event)"
                              (click)="showEventDetails(event)"
                            >
                              <div class="event-time">{{ format(event.start, 'h:mm a') }}</div>
                              <div class="event-title">{{ event.title }}</div>
                              @if (event.clientName) {
                                <div class="event-client">{{ event.clientName }}</div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }

              @case ('day') {
                <div class="day-view">
                  <div class="day-view-header">
                    <h2>{{ format(currentDate(), 'EEEE, MMMM d, yyyy') }}</h2>
                    @if (selectedDayWorkload()) {
                      <mat-chip-set>
                        <mat-chip [class]="'workload-chip workload-' + selectedDayWorkload()!.level">
                          <mat-icon>schedule</mat-icon>
                          {{ formatWorkloadHours(selectedDayWorkload()!.minutes) }} scheduled
                        </mat-chip>
                        <mat-chip>
                          <mat-icon>event</mat-icon>
                          {{ selectedDayEvents().length }} {{ selectedDayEvents().length === 1 ? 'event' : 'events' }}
                        </mat-chip>
                      </mat-chip-set>
                    }
                  </div>
                  
                  <!-- Time-based day view -->
                  <div class="day-time-grid">
                    @for (hour of hoursOfDay; track hour) {
                      <div class="day-hour-row">
                        <div class="hour-label">{{ formatHour(hour) }}</div>
                        <div class="hour-content">
                          @for (event of getEventsForHour(dayViewDay(), hour); track event.id) {
                            <mat-card 
                              class="day-event-card" 
                              [class.work-event]="event.isWorkEvent"
                              (click)="showEventDetails(event)"
                              tabindex="0"
                              role="article"
                              [attr.aria-label]="getEventAriaLabel(event)"
                            >
                              <mat-card-content>
                                <div class="event-time-range">
                                  {{ format(event.start, 'h:mm a') }} - {{ format(event.end, 'h:mm a') }}
                                </div>
                                <h3>{{ event.title }}</h3>
                                @if (event.clientName) {
                                  <p class="event-client">
                                    <mat-icon>pets</mat-icon>
                                    {{ event.clientName }}
                                  </p>
                                }
                                @if (event.serviceInfo) {
                                  <p class="event-service">
                                    <mat-icon>schedule</mat-icon>
                                    {{ event.serviceInfo.duration }} minutes
                                  </p>
                                }
                                @if (event.location) {
                                  <p class="event-location">
                                    <mat-icon>location_on</mat-icon>
                                    {{ event.location }}
                                  </p>
                                }
                              </mat-card-content>
                            </mat-card>
                          }
                        </div>
                      </div>
                    }
                  </div>

                  @if (selectedDayEvents().length === 0) {
                    <app-empty-state
                      icon="event_busy"
                      title="No events scheduled"
                      description="You have no appointments scheduled for this day."
                      [compact]="true"
                    ></app-empty-state>
                  }
                </div>
              }
            }
          </div>

          <!-- Event Details Sidebar -->
          @if (selectedEvent()) {
            <aside class="event-details-sidebar" role="complementary" aria-label="Event details">
              <div class="sidebar-header">
                <h3>Event Details</h3>
                <button mat-icon-button (click)="closeEventDetails()" aria-label="Close">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <div class="sidebar-content">
                <div class="event-detail-title">
                  <mat-icon [class.work-icon]="selectedEvent()!.isWorkEvent">
                    {{ selectedEvent()!.isWorkEvent ? 'pets' : 'event' }}
                  </mat-icon>
                  <h4>{{ selectedEvent()!.title }}</h4>
                </div>

                <div class="event-detail-row">
                  <mat-icon>schedule</mat-icon>
                  <div>
                    <div>{{ format(selectedEvent()!.start, 'EEEE, MMMM d, yyyy') }}</div>
                    <div class="detail-secondary">
                      {{ format(selectedEvent()!.start, 'h:mm a') }} - {{ format(selectedEvent()!.end, 'h:mm a') }}
                    </div>
                  </div>
                </div>

                @if (selectedEvent()!.clientName) {
                  <div class="event-detail-row">
                    <mat-icon>person</mat-icon>
                    <div>{{ selectedEvent()!.clientName }}</div>
                  </div>
                }

                @if (selectedEvent()!.location) {
                  <div class="event-detail-row">
                    <mat-icon>location_on</mat-icon>
                    <div>{{ selectedEvent()!.location }}</div>
                  </div>
                }

                @if (selectedEvent()!.serviceInfo) {
                  <div class="event-detail-row">
                    <mat-icon>category</mat-icon>
                    <div>
                      <div>{{ getServiceLabel(selectedEvent()!.serviceInfo!.type) }}</div>
                      <div class="detail-secondary">{{ selectedEvent()!.serviceInfo!.duration }} minutes</div>
                    </div>
                  </div>
                }

                @if (selectedEvent()!.description) {
                  <div class="event-detail-row description">
                    <mat-icon>notes</mat-icon>
                    <div>{{ selectedEvent()!.description }}</div>
                  </div>
                }
              </div>
            </aside>
          }
        </div>
      }
    </div>
  
